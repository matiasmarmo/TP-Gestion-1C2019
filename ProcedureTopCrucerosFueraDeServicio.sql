
CREATE PROCEDURE ZAFFA_TEAM.sp_diasFueraDeServicio @comienzoSemestre datetime2(3), @finSemestre datetime2(3) 
AS
go
declare  @comienzoSemestre datetime2(3);
declare  @finSemestre datetime2(3);
--set @comienzoSemestre='2018-07-01 00:00:00.000'; 
--set @finSemestre='2018-12-31 00:00:00.000';
SELECT top 5 est.CRUCERO_ID Crucero, SUM(DATEDIFF(DAY, case when est.ESTADO_ACTUAL = 'REINICIO DE SERVICIO' and est.FECHA_ANTERIOR < @comienzoSemestre then @comienzoSemestre 
                                              when est.ESTADO_ACTUAL = 'REINICIO DE SERVICIO' then est.FECHA_ANTERIOR
											  when est.ESTADO_ACTUAL = 'FUERA DE SERVICIO' then est.FECHA_ACTUAL
											  end, 
										 case when est.ESTADO_ACTUAL = 'REINICIO DE SERVICIO' then est.FECHA_ACTUAL
										      when est.ESTADO_ACTUAL = 'FUERA DE SERVICIO' then  @finSemestre
											  end
										      )) DiasFueraDeServicio
FROM ZAFFA_TEAM.Auditoria_estado_cruceros est
left join  ZAFFA_TEAM.Auditoria_estado_cruceros estSig on estSig.CRUCERO_ID = est.CRUCERO_ID and estSig.ESTADO_ACTUAL = 'REINICIO DE SERVICIO' and est.FECHA_ACTUAL = estSig.FECHA_ANTERIOR
WHERE (est.ESTADO_ACTUAL = 'REINICIO DE SERVICIO' and est.FECHA_ACTUAL >= @comienzoSemestre and est.FECHA_ACTUAL <= @finSemestre) or 
(est.ESTADO_ACTUAL = 'FUERA DE SERVICIO' and est.FECHA_ACTUAL >= @comienzoSemestre  and est.FECHA_ACTUAL <= @finSemestre AND (estSig.FECHA_ACTUAL is null or estSig.FECHA_ACTUAL > @finSemestre))
group by est.CRUCERO_ID
go



-- PRUEBA PRIMER SEMESTRE 2018 '2018-01-01 00:00:00.000' AL '2018-06-30 00:00:00.000'
-- PRUEBA SEGUNDO SEMESTRE 2018 '2018-07-01 00:00:00.000' AL '2018-12-31 00:00:00.000'

INSERT INTO ZAFFA_TEAM.Auditoria_estado_cruceros (CRUCERO_ID, FECHA_ACTUAL, ESTADO_ACTUAL, FECHA_ANTERIOR, ESTADO_ANTERIOR)
VALUES('PRUEBA-72879', '2017-07-09 00:00:00.000' ,'FUERA DE SERVICIO', '2017-06-19 00:00:00.000', 'ALTA')

INSERT INTO ZAFFA_TEAM.Auditoria_estado_cruceros (CRUCERO_ID, FECHA_ACTUAL, ESTADO_ACTUAL, FECHA_ANTERIOR, ESTADO_ANTERIOR)
VALUES('PRUEBA-72879', '2018-01-05 00:00:00.000' ,'REINICIO DE SERVICIO', '2017-07-09 00:00:00.000', 'FUERA DE SERVICIO')
-- 4 dias fuera de servicio SEMESTRE 2018
INSERT INTO ZAFFA_TEAM.Auditoria_estado_cruceros (CRUCERO_ID, FECHA_ACTUAL, ESTADO_ACTUAL, FECHA_ANTERIOR, ESTADO_ANTERIOR)
VALUES('PRUEBA-72879', '2018-02-05 00:00:00.000' ,'FUERA DE SERVICIO', '2018-08-19 00:00:00.000', 'REINICIO DE SERVICIO')

INSERT INTO ZAFFA_TEAM.Auditoria_estado_cruceros (CRUCERO_ID, FECHA_ACTUAL, ESTADO_ACTUAL, FECHA_ANTERIOR, ESTADO_ANTERIOR)
VALUES('PRUEBA-72879', '2018-03-05 00:00:00.000' ,'REINICIO DE SERVICIO', '2018-02-05 00:00:00.000', 'FUERA DE SERVICIO')
-- 28 DIAS FUERA DE SERVICIO + 4 -- SELECT DATEDIFF(DAY, '2018-02-05 00:00:00.000', '2018-03-05 00:00:00.000') = 28
-- 32 TOTAL

INSERT INTO ZAFFA_TEAM.Auditoria_estado_cruceros (CRUCERO_ID, FECHA_ACTUAL, ESTADO_ACTUAL, FECHA_ANTERIOR, ESTADO_ANTERIOR)
VALUES('PRUEBA-72879', '2018-06-20 00:00:00.000' ,'FUERA DE SERVICIO', '2018-03-05 00:00:00.000', 'REINICIO DE SERVICIO')

INSERT INTO ZAFFA_TEAM.Auditoria_estado_cruceros (CRUCERO_ID, FECHA_ACTUAL, ESTADO_ACTUAL, FECHA_ANTERIOR, ESTADO_ANTERIOR)
VALUES('PRUEBA-72879', '2018-07-20 00:00:00.000' ,'REINICIO DE SERVICIO', '2018-06-20 00:00:00.000', 'FUERA DE SERVICIO')
-- + 10 dias fuera de servicio EN EL PRIMER SEMESTRE
-- TOTAL 42 dias fuera de servicio EN EL PRIMER SEMESTRE 
-- 19 dias dias fuera de servicio EN EL SEGUNDO SEMESTRE -- SELECT DATEDIFF(DAY, '2018-07-01 00:00:00.000', '2018-07-20 00:00:00.000') = 19


INSERT INTO ZAFFA_TEAM.Auditoria_estado_cruceros (CRUCERO_ID, FECHA_ACTUAL, ESTADO_ACTUAL, FECHA_ANTERIOR, ESTADO_ANTERIOR)
VALUES('ILELMR-72879', '2018-07-09 00:00:00.000' ,'FUERA DE SERVICIO', '2018-06-19 00:00:00.000', 'ALTA')

INSERT INTO ZAFFA_TEAM.Auditoria_estado_cruceros (CRUCERO_ID, FECHA_ACTUAL, ESTADO_ACTUAL, FECHA_ANTERIOR, ESTADO_ANTERIOR)
VALUES('ILELMR-72879', '2018-08-19 00:00:00.000' ,'REINICIO DE SERVICIO', '2018-07-09 00:00:00.000', 'FUERA DE SERVICIO')
-- 41 dias fuera de servicio -- SELECT DATEDIFF(DAY, '2018-07-09 00:00:00.000', '2018-08-19 00:00:00.000') = 41

INSERT INTO ZAFFA_TEAM.Auditoria_estado_cruceros (CRUCERO_ID, FECHA_ACTUAL, ESTADO_ACTUAL, FECHA_ANTERIOR, ESTADO_ANTERIOR)
VALUES('ILELMR-72879', '2018-10-19 00:00:00.000' ,'FUERA DE SERVICIO', '2018-08-19 00:00:00.000', 'REINICIO DE SERVICIO')

INSERT INTO ZAFFA_TEAM.Auditoria_estado_cruceros (CRUCERO_ID, FECHA_ACTUAL, ESTADO_ACTUAL, FECHA_ANTERIOR, ESTADO_ANTERIOR)
VALUES('ILELMR-72879', '2018-11-19 00:00:00.000' ,'REINICIO DE SERVICIO', '2018-10-19 00:00:00.000', 'FUERA DE SERVICIO')
-- + 31 dias fuera de servicio 
-- total 72 dias fuera de servicio EN EL SEGUNDO SEMESTRE



UPDATE ZAFFA_TEAM.Crucero 
set ESTADO_CRUCERO = 'FUERA DE SERVICIO'
WHERE CRUCERO_ID = 'ILELMR-72879'



